version: "3.9"

services:
  chatengine:
    image: ghcr.io/cesarcabe/chatengine:latest
    container_name: chatengine
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}

      # URL interna do Evolution (comunicação entre containers)
      EVOLUTION_API_URL: http://evolution_api:8080
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
      EVOLUTION_WEBHOOK_SECRET: ${EVOLUTION_WEBHOOK_SECRET}

      CHATENGINE_JWT_SECRET: ${CHATENGINE_JWT_SECRET}
      OUTBOX_WORKER_TOKEN: ${OUTBOX_WORKER_TOKEN}

      SUPABASE_MEDIA_BUCKET: ${SUPABASE_MEDIA_BUCKET}
      SUPABASE_MEDIA_URL_EXPIRES_IN: ${SUPABASE_MEDIA_URL_EXPIRES_IN}

      NODE_ENV: production
    networks:
      - app_network  # Rede compartilhada com Evolution
      - nginx-proxy-manager_default  # Apenas para proxy reverso

  chatengine-worker:
    image: ghcr.io/cesarcabe/chatengine:latest
    container_name: chatengine-worker
    restart: unless-stopped
    command:
      - /bin/sh
      - -c
      - |
        while true; do
          wget --quiet --method=POST \
            --header="Authorization: Bearer $$OUTBOX_WORKER_TOKEN" \
            http://chatengine:3000/api/internal/outbox/process >/dev/null 2>&1 || true
          sleep 5
        done
    environment:
      OUTBOX_WORKER_TOKEN: ${OUTBOX_WORKER_TOKEN}
    depends_on:
      - chatengine
    networks:
      - app_network

networks:
  # Rede principal - EXTERNA (com internet)
  # ChatEngine e Evolution precisam de internet
  app_network:
    name: app_network
    driver: bridge
    external: false  # Não é interna!

  # Proxy reverso (já existe)
  nginx-proxy-manager_default:
    external: true