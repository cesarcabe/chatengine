# Auditoria Arquitetural ‚Äî ChatEngine

**Nota:** Documento hist√≥rico (15/01/2026). Algumas refer√™ncias a caminhos antigos (ex: `src/modules/chat`) foram preservadas para rastreabilidade. A estrutura atual do core est√° em `src/modules/chatengine`.

Baseado no c√≥digo avaliado na √©poca (Next.js + rotas API + m√≥dulos `chat`), segue uma an√°lise objetiva e cr√≠tica, focada no papel de ‚Äúmotor de conversa√ß√£o‚Äù reutiliz√°vel.

## 1Ô∏è‚É£ Vis√£o Geral
- **Arquitetura atual:** monolito Next.js com API routes e um m√≥dulo ‚Äúchat‚Äù que mistura backend e frontend. N√£o h√° pipeline event-driven nem persist√™ncia real.
- **Comportamento predominante:** **backend acoplado ao CRM/UI** (com simula√ß√µes). √â um **motor reutiliz√°vel parcial** apenas no conceito, pois falta tenancy, storage real e boundaries.
- **Acoplamento:** **alto**. O core depende de API routes Next.js e storage in-memory, sem infraestrutura real, sem tenancy, sem interfaces de aplica√ß√£o isoladas.  
  Evid√™ncias: persist√™ncia em mem√≥ria e repos ‚Äúmock‚Äù usados por padr√£o.  

## 2Ô∏è‚É£ Limites de M√≥dulo (Modular Monolith)
**M√≥dulos que existem ou deveriam existir:**
- `webhooks` (inbound events)
- `messages` (write + status)
- `conversations`
- `providers` (WhatsApp/Evolution)
- `outbox`/`jobs` (envio confi√°vel)
- `tenancy`/`workspace`
- `media`/`attachments`
- `realtime` (n√£o existe)

**Limites confusos/inexistentes:**
- Webhook escreve direto em repos e atualiza conversa (sem orquestra√ß√£o).
- Envio de mensagens executa provider e persiste no mesmo handler (sem aplica√ß√£o/outbox).

**Invas√£o de responsabilidade do SaaS:**  
N√£o h√° regras de neg√≥cio de CRM, mas h√° aus√™ncia de tenancy e auth real; isso obriga o frontend a segurar isolamento ‚Äî o que √© erro arquitetural.

## 3Ô∏è‚É£ Clean / Hexagonal (dentro do ChatEngine)
- **Domain: Parcial**  
  H√° entidades (`Message`, `Conversation`), mas sem invariantes e sem `workspace_id`.
- **Application: Ruim**  
  N√£o existem casos de uso; a l√≥gica est√° nos handlers HTTP.
- **Infrastructure: Ruim**  
  Provider Evolution e storage in-memory s√£o usados diretamente pelos handlers.

## 4Ô∏è‚É£ Event-driven e Consist√™ncia
- Eventos s√£o tratados como **chamadas diretas**, n√£o como fatos persistidos.
- **Idempot√™ncia:** existe apenas por `providerMessageId`, sem `workspace_id`.
- **Duplicados e fora de ordem:**  
  - `messages.update` pode chegar antes de `messages.upsert` e √© descartado.  
  - N√£o h√° retry/queue/outbox, ent√£o consist√™ncia eventual √© fr√°gil.

## 5Ô∏è‚É£ Multi-tenancy (Workspace)
- **Workspace_id inexistente** nas entidades e queries.
- **Risco de vazamento total** entre workspaces se o produto for usado por m√∫ltiplos clientes.
- Isolamento depende do frontend (erro).

## 6Ô∏è‚É£ Banco e Ownership
- Hoje: **escreve mensagens diretamente**, mas em **storage in-memory**.
- **Mistura responsabilidades:** o backend n√£o √© owner l√≥gico real do Supabase.  
**Mudan√ßa necess√°ria:**  
- Criar repos de persist√™ncia Supabase com `workspace_id`, `external_message_id`, `provider`, `status`.  
- Mover a escrita das tabelas para o ChatEngine via casos de uso internos.  
- O frontend passa a s√≥ ler/emitir comandos.

## 7Ô∏è‚É£ Acoplamento com Evolution / WhatsApp
- O core chama diretamente Evolution via provider ‚Äî h√° adapter, mas o resto do sistema n√£o isola bem.
- Trocar de provider exigir√° mexer em handlers (payloads, media etc.) porque parsing est√° no webhook handler.

## 8Ô∏è‚É£ Extensibilidade (menu de contexto / a√ß√µes)
- N√£o h√° endpoint espec√≠fico para ‚Äúcontexto de mensagem‚Äù.
- O modelo suporta `metadata`, mas n√£o h√° APIs para expor contexto de forma segura.
- Falta uma camada de ‚ÄúContext API‚Äù e ‚ÄúCommand API‚Äù desacopladas.

## 9Ô∏è‚É£ Escala e Concorr√™ncia
- **Quebra primeiro em volume:** storage in-memory, sem √≠ndices e sem persist√™ncia.
- **M√∫ltiplos n√∫meros por workspace:** `conversationId` √© s√≥ n√∫mero (colis√£o).
- **Race conditions:** atualiza√ß√£o de conversa e mensagem sem transa√ß√µes.
- **Gargalos:** tudo √© s√≠ncrono dentro do request; sem worker/outbox.

---

# Security Audit (obrigat√≥rio)

## S1Ô∏è‚É£ Autentica√ß√£o e Autoriza√ß√£o ‚Äî **Cr√≠tico**
- **Problema:** auth √© ‚Äúmock‚Äù e aceita qualquer token.
- **Risco real:** qualquer pessoa com token qualquer acessa mensagens/conversas e m√≠dia.
- **Corre√ß√£o pr√°tica:** JWT verificado, derivar `workspace_id` do token, middleware por rota.

## S2Ô∏è‚É£ Isolamento de Dados (Tenancy) ‚Äî **Cr√≠tico**
- **Problema:** `workspace_id` inexistente no dom√≠nio e nas consultas.
- **Risco real:** vazamento total entre clientes (IDOR).
- **Corre√ß√£o pr√°tica:** adicionar `workspace_id` em todas as tabelas + RLS + filtros obrigat√≥rios no repository.

## S3Ô∏è‚É£ Webhook Security ‚Äî **Cr√≠tico**
- **Problema:** webhook aceita payload sem assinatura/token.
- **Risco real:** mensagens forjadas, spam, falsifica√ß√£o de status.
- **Corre√ß√£o pr√°tica:** exigir HMAC/token + timestamp; rejeitar replay; whitelisting de IP como camada adicional.

## S4Ô∏è‚É£ API Security ‚Äî **Cr√≠tico**
- **Problema:** sem API keys por workspace, sem scopes, sem rate limit.
- **Risco real:** brute force, scraping e abuso de m√≠dia.
- **Corre√ß√£o pr√°tica:** API keys por workspace + scopes + rate limit por IP/workspace.

## S6Ô∏è‚É£ Storage de M√≠dia ‚Äî **Cr√≠tico**
- **Problema:** m√≠dia salva como data URL e proxy direto no backend.
- **Risco real:** exposi√ß√£o de dados sens√≠veis, payloads gigantes na mem√≥ria, sem expira√ß√£o.
- **Corre√ß√£o pr√°tica:** armazenar em bucket (Supabase Storage/S3) + URLs assinadas expir√°veis.

## S7Ô∏è‚É£ Extensibilidade e Plugins ‚Äî **Parcial**
- **Problema:** n√£o h√° controles de permiss√µes por a√ß√£o porque o recurso n√£o existe.
- **Risco real:** quando existir, pode expor dados sem escopo.
- **Corre√ß√£o pr√°tica:** Context API com escopo m√≠nimo + autoriza√ß√£o por workspace + allowlist de a√ß√µes.

## S8Ô∏è‚É£ Auditoria e Rastreabilidade ‚Äî **Cr√≠tico**
- **Problema:** n√£o h√° trilha de auditoria nem actor_id.
- **Risco real:** imposs√≠vel responder ‚Äúquem fez o qu√™‚Äù.
- **Corre√ß√£o pr√°tica:** tabela `message_events` (entrada/sa√≠da/falha) com `workspace_id`, `actor_id`, `timestamp`, `provider_id`.

## S9Ô∏è‚É£ Resili√™ncia a Abuso ‚Äî **Cr√≠tico**
- **Problema:** sem rate limit, sem fila, sem dedupe robusto.
- **Risco real:** flood derruba inst√¢ncia, consumo de banda/mem√≥ria.
- **Corre√ß√£o pr√°tica:** rate limit, queue/outbox, retry com backoff, idempotency keys.

---

## üîü Avalia√ß√£o Final
**Classifica√ß√£o:** ‚úÖ **precisa de reorganiza√ß√£o modular moderada**  
Justificativa: h√° dom√≠nio b√°sico e adapter de provider, mas faltam tenancy, application layer, storage real, outbox, seguran√ßa m√≠nima. Ainda d√° para evoluir de forma incremental sem reescrever tudo.

## 1Ô∏è‚É£1Ô∏è‚É£ Plano de A√ß√£o

### Etapa 1 ‚Äî Ajustes m√≠nimos e seguros (baixo risco)
- **O que mudar:**  
  - Autentica√ß√£o real com JWT + `workspace_id` derivado  
  - Validar webhook com secret/HMAC  
  - Adicionar `workspace_id` obrigat√≥rio nos models/repos  
- **Por que:** seguran√ßa e isolamento s√£o cr√≠ticos para SaaS multi-tenant.  
- **Impacto:** evita vazamento e abuso j√° na fase inicial.  
- **Risco:** baixo; mudan√ßas locais.

### Etapa 2 ‚Äî Modulariza√ß√£o e corre√ß√£o de boundaries
- **O que mudar:**  
  - Criar `Application` (use-cases) para: `IngestWebhook`, `SendMessage`, `UpdateStatus`  
  - Repos Supabase para mensagens/conversas com idempot√™ncia (`provider_message_id + workspace`)  
  - Separar `webhooks` e `commands`  
- **Por que:** reduzir acoplamento HTTP ‚Üî dom√≠nio e permitir evolu√ß√£o sem refatorar tudo.  
- **Impacto:** melhora coer√™ncia e reuso do ChatEngine.  
- **Risco:** m√©dio; exige reestrutura√ß√£o interna.

### Etapa 3 ‚Äî Alinhamento total com Modular Monolith + Clean/Hex
- **O que mudar:**  
  - Outbox/worker para envio confi√°vel  
  - Event log imut√°vel (message_facts) + proje√ß√µes para conversas  
  - Context API para extens√µes SaaS  
- **Por que:** garantir consist√™ncia eventual, escalabilidade e extensibilidade real.  
- **Impacto:** motor robusto e reutiliz√°vel em m√∫ltiplos SaaS.  
- **Risco:** m√©dio-alto; exige mudan√ßas de fluxo e novas tabelas.

